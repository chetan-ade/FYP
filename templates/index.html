<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Nuclear Fallout Radiation Prediction</title>

    <link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/indexStyle.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Martel&display=swap">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"> </script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://unpkg.com/gijgo@1.9.13/js/gijgo.min.js" type="text/javascript"></script>
    <link href="https://unpkg.com/gijgo@1.9.13/css/gijgo.min.css" rel="stylesheet" type="text/css" />
    <script>
        function setDate() {
            var today = new Date();

            if (today.getMonth() < 9) {
                var date = '0' + (today.getMonth() + 1) + '/' + today.getDate() + '/' + today.getFullYear();
            } else {
                var date = (today.getMonth() + 1) + '/' + today.getDate() + '/' + today.getFullYear();
            }

            document.getElementById("datepicker").value = date;
        }
    </script>
</head>

<body onload="setDate()">
    <script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAqpHfAhTZPkSXc3Bs6dskNBv-GXIVOa2I&libraries=places">
    </script>
    <video autoplay muted loop id="bgVideo">
        <source src="{{url_for('static', filename='index.mp4')}}" type="video/mp4">
    </video>

    <div id="indexPageContent">
        <h1>Experience the power of a nuclear blast in your area</h1>
        <br><br>
        <form action="/" method="post">
            <div class="input-group mb-3" style="width: 100%;">
                <input id="startInputText" name="inputLoc" type="text" placeholder="Enter the location"
                    class="form-control" aria-label="Text input with dropdown button"></input>
                <input type="hidden" name="locLat" value="" id="lat">
                <input type="hidden" name="locLng" value="" id="lng">
                <div class="input-group-append">
                    <button id="locateMe" class="btn btn-secondary" type="button" data-toggle="tooltip"
                        data-placement="bottom" title="Locate Me" onclick="getLocation()"><img
                            src="../static/locateMe.png"></button>
                </div>
            </div>
            <div style="background-color: white; padding: 0; margin: 0;">
                <input id="datepicker" width="100%" name="dateInput" />
            </div>
            <p id="demo" style="padding:10px;"></p>
            <button type="submit" id="predict">Submit</button>
            <div id="outerMapID">
                <div id="mapID"></div>
            </div>
        </form>
        <br><br>
        <embed type="video/mp4"
            style="width: 140%; height: 90%; margin-left: -20%; margin-bottom: 10%; visibility: {{ visibility }};"
            src={{ output_path }} max />
    </div>

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous">
    </script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous">
    </script>

    <script type="text/javascript">
        $('#datepicker').datepicker({
            uiLibrary: 'bootstrap4'
        });
    </script>
    <script>
        var x = document.getElementById("demo");
        var y = document.getElementById("startInputText");
        var z;
        var startLat = undefined;
        var startLng = undefined;
        var startAdd = undefined;
        var map = undefined;
        var temp;
        var marker = undefined;
        var defaultBounds = new google.maps.LatLngBounds(
            new google.maps.LatLng(23.63936, 68.14712),
            new google.maps.LatLng(28.20453, 97.34466));
        var options = {
            bounds: defaultBounds
        };

        google.maps.event.addDomListener(window, 'load', function () {
            var places = new google.maps.places.Autocomplete(document.getElementById('startInputText'),
                options);
            google.maps.event.addListener(places, 'place_changed', function () {
                var place = places.getPlace();
                startAdd = place.formatted_address;
                startLat = place.geometry.location.lat();
                startLng = place.geometry.location.lng();
                if (typeof map !== "undefined") {
                    var location2 = new google.maps.LatLng(startLat, startLng);
                    marker.setPosition(location2);
                    map.setCenter({
                        lat: startLat,
                        lng: startLng
                    });
                }
                // var mesg = "Address: " + startAdd;
                // mesg += "\nLatitude: " + startLat;
                // mesg += "\nLongitude: " + startLng;
                // alert(mesg);
                document.getElementById("lat").value = startLat
                document.getElementById("lng").value = startLng
            });
        });

        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showPosition, showError);
                x.innerHTML = "";
            } else {
                x.innerHTML = "Geolocation is not supported by this browser.";
            }
        }

        function showPosition(position) {
            z = position.coords.latitude +
                "," + position.coords.longitude;
            startLat = position.coords.latitude;
            startLng = position.coords.longitude;
            GetAddress();

            // var mesg = "Address: " + startAdd;
            // mesg += "\nLatitude: " + startLat;
            // mesg += "\nLongitude: " + startLng;
            // alert(mesg);
            document.getElementById("lat").value = startLat
            document.getElementById("lng").value = startLng
        }

        function showError(error) {
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    x.innerHTML = "User denied the request for Geolocation."
                    break;
                case error.POSITION_UNAVAILABLE:
                    x.innerHTML = "Location information is unavailable."
                    break;
                case error.TIMEOUT:
                    x.innerHTML = "The request to get user location timed out."
                    break;
                case error.UNKNOWN_ERROR:
                    x.innerHTML = "An unknown error occurred."
                    break;
            }
        }

        function GetAddress() {
            var latlngStr = z.split(',', 2);
            var lat = parseFloat(latlngStr[0]);
            var lng = parseFloat(latlngStr[1]);
            var latlng = new google.maps.LatLng(lat, lng);
            var geocoder = geocoder = new google.maps.Geocoder();
            geocoder.geocode({
                'latLng': latlng
            }, function (results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (results[0]) {
                        y.value = results[0].formatted_address;
                        startAdd = y.value;
                        if (typeof map !== "undefined") {
                            var location1 = new google.maps.LatLng(startLat, startLng);
                            marker.setPosition(location1);
                            map.setCenter({
                                lat: startLat,
                                lng: startLng
                            });
                        }
                    }
                }
            });
        }

        function startMap() {
            var a = document.getElementById("mapID");
            var myLatLng = {
                lat: 19.0330,
                lng: 73.0297
            };
            map = new google.maps.Map(document.getElementById("mapID"), {
                zoom: 12,
                center: myLatLng
            });
            marker = new google.maps.Marker({
                position: myLatLng,
                map: map,
                animation: google.maps.Animation.DROP,
                title: 'Select your Location',
                draggable: true
            });
            google.maps.event.addListener(map, 'click', function (event) {
                placeMarker(event.latLng);
            });

            function placeMarker(location) {
                marker.setPosition(location);
                toggleBounce();
                var geocoder = geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    'latLng': location
                }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        if (results[0]) {
                            y.value = results[0].formatted_address;
                            startLat = location.lat();
                            startLng = location.lng();
                            startAdd = y.value;

                            // var mesg = "Address: " + startAdd;
                            // mesg += "\nLatitude: " + startLat;
                            // mesg += "\nLongitude: " + startLng;
                            // alert(mesg);
                            document.getElementById("lat").value = startLat
                            document.getElementById("lng").value = startLng
                        }
                    }
                });
            }

            function toggleBounce() {
                marker.setAnimation(google.maps.Animation.BOUNCE);
                setTimeout(function () {
                    marker.setAnimation(null);
                }, 375);
            }

            google.maps.event.addListener(marker, 'dragend', function () {
                var lat = marker.getPosition().lat();
                var lng = marker.getPosition().lng();
                var location = new google.maps.LatLng(lat, lng);
                var geocoder = geocoder = new google.maps.Geocoder();
                geocoder.geocode({
                    'latLng': location
                }, function (results, status) {
                    if (status == google.maps.GeocoderStatus.OK) {
                        if (results[0]) {
                            y.value = results[0].formatted_address;
                            startLat = lat;
                            startLng = lng;
                            startAdd = y.value;

                            // var mesg = "Address: " + startAdd;
                            // mesg += "\nLatitude: " + startLat;
                            // mesg += "\nLongitude: " + startLng;
                            // alert(mesg);
                            document.getElementById("lat").value = startLat
                            document.getElementById("lng").value = startLng
                        }
                    }
                });
            })
        }
    </script>
</body>

</html>